/*! 
DataStore Middelware for Backbone

Copyright (c) 2013 James Charlesworth, contributors
Licensed under the MIT license.
*/
define(["jquery","backbone"],function(a,b){var c=[].slice,d=function(){this.events=_.extend({},b.Events),this.isReady=!1,this.cache={}};d.prototype.register=function(b,d){var e=this,f=a.Deferred(),g=b;d=d||{},"undefined"==typeof d.reset&&(d.reset=!1);var h={};return _.each(b,function(a,c){"undefined"!=typeof e.cache[a]&&b.splice(c,1);var d=a.split("?");d.length>1&&(a=d[0],b[c]=a,h[a]=d[1].substring("3",d[1].length))}),require(b,function(){var i=c.call(arguments),j=[];_.each(i,function(c,f){var g,i=a.Deferred();if("undefined"!=typeof h[b[f]]){g={};var k=h[b[f]];g.id=k,b[f]+="?id="+k}var l=e.getFromLocalStorage(b[f]);l&&(g=l),e.cache[b[f]]=new c(g),e.cache[b[f]]._dataStoreKey=b[f],e.cache[b[f]].on("sync",function(a){e.saveToLocalStorage(a)}),function(a,b,c){c&&!d.reset?(e.events.trigger("ready:"+b,a),i.resolve()):a.fetch().done(function(){e.events.trigger("ready:"+b,a),i.resolve()})}(e.cache[b[f]],b[f],l),j.push(i)}),a.when.apply(a,j).done(function(){var a=_.map(g,function(a){return e.cache[a]});f.resolve.apply(null,a),e.events.trigger("ready"),e.saveToLocalStorage()}).fail(function(){throw new Error("Failed call")})}),f.promise()},d.prototype.get=function(a){if("undefined"!=typeof this.cache[a])return this.cache[a];throw new Error(a+" is not defined.")},d.prototype.saveToLocalStorage=function(a){if("undefined"==typeof a)try{_.each(this.cache,function(a,b){var c=JSON.stringify(a.toJSON());window.localStorage.setItem(b,c)})}catch(b){}else try{var c=JSON.stringify(a.toJSON());window.localStorage.setItem(a._dataStoreKey,c)}catch(b){}},d.prototype.getFromLocalStorage=function(a){if("undefined"==typeof a)throw new Error("Key not provided to get from localStorage");var b;try{b=JSON.parse(window.localStorage.getItem(a))}catch(c){}return b},d.prototype.removeFromLocalStorage=function(a){try{delete window.localStorage[a]}catch(b){}};var e;return"undefined"==typeof window._dataStore?(e=new d,window._dataStore=e):e=window._dataStore,e.events.on("ready",function(){e.isReady=!0}),e});